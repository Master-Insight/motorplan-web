---
import Layout from "@/layouts/Layout.astro";
import Frame from "@/components/Frame.astro";
import config from "@config";

const { mediosPago } = config;
const opcionesMedios = [
  "Banco Santander",
  "Banco ICBC",
  "Banco Provincia de Neuquén",
  "Mercado Pago",
];
---

<Layout title="Medios de Pago - Motorplan">
  <Frame>
    <section class="py-16 container mx-auto px-4">
      <!-- Aviso inicial -->
      <div class="mb-12 text-center">
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Medios de Pago</h2>
        <p class="text-lg text-gray-700">
          Motorplan S.A. de Capitalización y ahorro no cuenta con <strong
            >COBRADORES A DOMICILIO</strong
          >.
        </p>
      </div>

      <!-- Botones tipo radio adornados -->
      <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div>
          <input
            type="radio"
            id="opcionA"
            name="seccion"
            value="A"
            class="hidden"
            checked
          />
          <label
            for="opcionA"
            class="block text-center cursor-pointer px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300"
          >
            Transferencias y depósitos bancarios
          </label>
        </div>
        <div>
          <input
            type="radio"
            id="opcionB"
            name="seccion"
            value="B"
            class="hidden"
          />
          <label
            for="opcionB"
            class="block text-center cursor-pointer px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300"
          >
            Solicita Link de Pago
          </label>
        </div>
        <div>
          <input
            type="radio"
            id="opcionC"
            name="seccion"
            value="C"
            class="hidden"
          />
          <label
            for="opcionC"
            class="block text-center cursor-pointer px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300"
          >
            Solicita adhesión en débito automático en tarjeta de crédito
          </label>
        </div>
        <div>
          <input
            type="radio"
            id="opcionD"
            name="seccion"
            value="D"
            class="hidden"
          />
          <label
            for="opcionD"
            class="block text-center cursor-pointer px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300"
          >
            Informa tu pago
          </label>
        </div>
      </div>

      <!-- Sección A: Transferencias y depósitos bancarios -->
      <div id="seccionA" class="seccion">
        <div class="mb-12">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
            A) Transferencias y depósitos bancarios:
          </h3>
          <!-- Contenedor responsivo para los medios de pago -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {
              mediosPago.map((banco) => (
                <div class="p-4 border rounded shadow-sm text-center">
                  <h4 class="text-xl font-semibold text-gray-800 mb-2">
                    {banco.nombre}
                  </h4>
                  <ul class="list-disc inline-block text-left text-gray-700">
                    {banco.detalles.map((detalle) => (
                      <li>{detalle}</li>
                    ))}
                  </ul>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <!-- Sección B: Solicita Link de Pago -->
      <div id="seccionB" class="seccion hidden">
        <div class="mb-12">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
            B) Solicita Link de Pago
          </h3>
          <p class="text-lg text-gray-700 mb-4 text-center">
            Complete el siguiente formulario con su DNI, número de contacto,
            medio de pago a utilizar y nombre y apellido. Posteriormente, nos
            comunicaremos por teléfono.
          </p>
          <form
            id="formBPayForm"
            class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 max-w-md mx-auto"
            onsubmit="handleSubmitB(event)"
          >
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="dniB">DNI</label
              >
              <input
                id="dniB"
                type="text"
                name="dniB"
                placeholder="Ingrese su DNI"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="contactoB">Número de Contacto</label
              >
              <input
                id="contactoB"
                name="contactoB"
                type="text"
                placeholder="Ingrese su número de contacto"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="medioB">Medio de Pago</label
              >
              <input
                id="medioB"
                name="medioB"
                type="text"
                placeholder="Medio de pago a utilizar"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="nombreB">Nombre y Apellido</label
              >
              <input
                id="nombreB"
                name="nombreB"
                type="text"
                placeholder="Ingrese su nombre y apellido"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="text-center">
              <button
                type="submit"
                class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded"
              >
                Enviar Solicitud
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Sección C: Solicita adhesión en débito automático en tarjeta de crédito -->
      <div id="seccionC" class="seccion hidden">
        <div class="mb-12">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
            C) Solicita adhesión en débito automático en tarjeta de crédito
          </h3>
          <p class="text-lg text-gray-700 mb-4 text-center">
            Complete el siguiente formulario con su DNI, número de contacto y
            nombre y apellido para gestionar el proceso de adhesión.
          </p>
          <form
            id="formCPayForm"
            class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 max-w-md mx-auto"
            onsubmit="handleSubmitC(event)"
          >
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="dniC">DNI</label
              >
              <input
                id="dniC"
                name="dniC"
                type="text"
                placeholder="Ingrese su DNI"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="contactoC">Número de Contacto</label
              >
              <input
                id="contactoC"
                name="contactoC"
                type="text"
                placeholder="Ingrese su número de contacto"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="nombreC">Nombre y Apellido</label
              >
              <input
                id="nombreC"
                name="nombreC"
                type="text"
                placeholder="Ingrese su nombre y apellido"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="text-center">
              <button
                type="submit"
                class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded"
              >
                Enviar Solicitud
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Sección D: Informa tu pago -->
      <div id="seccionD" class="seccion hidden">
        <div class="mb-12">
          <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">
            D) Informa tu pago
          </h3>
          <p class="text-lg text-gray-700 mb-4 text-center">
            Complete el siguiente formulario con su DNI, monto, fecha,
            seleccione el medio de pago utilizado y adjunte el comprobante.
          </p>
          <form
            class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 max-w-md mx-auto"
            id="formDPayForm"
            onsubmit="handleSubmitD(event)"
            enctype="multipart/form-data"
          >
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="nombreD">Nombre y Apellido</label
              >
              <input
                id="nombreD"
                name="nombreD"
                type="text"
                placeholder="Ingrese su nombre y apellido"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="dniD">DNI</label
              >
              <input
                id="dniD"
                name="dniD"
                type="text"
                placeholder="Ingrese su DNI"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="montoD">Monto</label
              >
              <input
                id="montoD"
                name="montoD"
                type="number"
                placeholder="Ingrese el monto"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="fechaD">Fecha</label
              >
              <input
                id="fechaD"
                name="fechaD"
                type="date"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="medioD">Medio de Pago Utilizado</label
              >
              <select
                id="medioD"
                name="medioD"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              >
                <option value="">Seleccione una opción</option>
                {
                  opcionesMedios.map((opcion) => (
                    <option value={opcion}>{opcion}</option>
                  ))
                }
              </select>
            </div>
            <div class="mb-4">
              <label
                class="block text-gray-700 text-sm font-bold mb-2"
                for="comprobante">Comprobante</label
              >
              <input
                id="comprobante"
                name="comprobante"
                type="file"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700"
              />
            </div>
            <div class="text-center">
              <button
                type="submit"
                class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded"
              >
                Enviar Información
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Modal "Enviando" -->
    <div
      id="modal"
      class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden"
    >
      <div class="bg-white p-6 rounded-lg shadow-lg text-center">
        <p class="text-md font-medium">Enviando...</p>
      </div>
    </div>

    <script>
      // Se obtienen todos los radio buttons y las secciones correspondientes
      const radios = document.querySelectorAll('input[name="seccion"]');
      const sections: Record<string, HTMLElement | null> = {
        A: document.getElementById("seccionA"),
        B: document.getElementById("seccionB"),
        C: document.getElementById("seccionC"),
        D: document.getElementById("seccionD"),
      };

      radios.forEach((radio) => {
        if (radio instanceof HTMLInputElement) {
          radio.addEventListener("change", () => {
            Object.values(sections).forEach((section) => {
              section?.classList.add("hidden"); // Evita error si es null
            });

            const selectedSection = sections[radio.value]; // Obtiene la sección correspondiente
            selectedSection?.classList.remove("hidden"); // Verifica que no sea null antes de quitar "hidden"
          });
        }
      });
    </script>

    <!-- Script Enviar Formulario B -->
    <script is:inline>
      async function handleSubmitB(event) {
        event.preventDefault(); // Evita el comportamiento por defecto del formulario

        const form = document.getElementById("formBPayForm");
        const modal = document.getElementById("modal");

        // Mostrar el modal de "Enviando..."
        modal.classList.remove("hidden");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/payB.json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (response.ok) {
            // Redirigir a la página de "gracias por tu contacto"
            window.location.href = "/graciasportucontacto";
          } else {
            alert("Error al enviar los datos");
          }
        } catch (error) {
          alert("Ocurrió un error inesperado: " + error.message);
        } finally {
          // Ocultar el modal de "Enviando..."
          modal.classList.add("hidden");
        }
      }
    </script>

    <!-- Script Enviar Formulario C -->
    <script is:inline>
      async function handleSubmitC(event) {
        event.preventDefault(); // Evita el comportamiento por defecto del formulario

        const form = document.getElementById("formCPayForm");
        const modal = document.getElementById("modal");

        // Mostrar el modal de "Enviando..."
        modal.classList.remove("hidden");

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
          const response = await fetch("/api/payC.json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          if (response.ok) {
            // Redirigir a la página de "gracias por tu contacto"
            window.location.href = "/graciasportucontacto";
          } else {
            alert("Error al enviar los datos");
          }
        } catch (error) {
          alert("Ocurrió un error inesperado: " + error.message);
        } finally {
          // Ocultar el modal de "Enviando..."
          modal.classList.add("hidden");
        }
      }
    </script>

    <!-- Script Enviar Formulario D -->
    <script is:inline>
      async function handleSubmitD(event) {
        event.preventDefault(); // Evita el comportamiento por defecto del formulario

        const form = document.getElementById("formDPayForm");
        const modal = document.getElementById("modal");

        // Mostrar el modal de "Enviando..."
        modal.classList.remove("hidden");

        // Validaciones

        // Obtener los valores del formulario
        const nombre = form.nombreD.value.trim();
        const dni = form.dniD.value.trim();
        const monto = parseFloat(form.montoD.value);
        const fecha = form.fechaD.value;
        const medio = form.medioD.value;
        const file = form.comprobante.files[0];

        // Validar campos requeridos
        if (!nombre || !dni || !monto || !fecha || !medio || !file) {
          alert("Todos los campos son obligatorios.");
          modal.classList.add("hidden");
          return;
        }

        // Validar DNI (7 u 8 dígitos)
        const dniRegex = /^\d{7,8}$/;
        if (!dniRegex.test(dni)) {
          alert("El DNI debe tener entre 7 y 8 dígitos.");
          modal.classList.add("hidden");
          return;
        }

        // Validar fecha
        const fechaActual = new Date();
        const fechaIngresada = new Date(fecha);
        const seisMesesAtras = new Date();
        seisMesesAtras.setMonth(fechaActual.getMonth() - 6);

        if (fechaIngresada > fechaActual) {
          alert("La fecha no puede ser mayor a la fecha actual.");
          modal.classList.add("hidden");
          return;
        }

        if (fechaIngresada < seisMesesAtras) {
          alert(
            "La fecha no puede ser menor a 6 meses antes de la fecha actual.",
          );
          modal.classList.add("hidden");
          return;
        }

        // Validar monto
        if (monto <= 49) {
          alert("El monto debe ser valido.");
          modal.classList.add("hidden");
          return;
        }

        // Validar archivo
        const tiposPermitidos = [
          "application/pdf",
          "image/jpeg",
          "image/jpg",
          "image/png",
          "image/bmp",
        ];
        const tamanoMaximo = 25 * 1024 * 1024; // 25 MB

        if (!tiposPermitidos.includes(file.type)) {
          alert("Solo se permiten archivos PDF o imágenes (JPEG, PNG).");
          modal.classList.add("hidden");
          return;
        }

        if (file.size > tamanoMaximo) {
          alert("El archivo no puede superar los 25 MB.");
          modal.classList.add("hidden");
          return;
        }

        // si pasa validaciones se sigue a la API
        const formData = new FormData(form); // se envia como formData y no como JSON

        try {
          const response = await fetch("/api/payD.json", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            // Redirigir a la página de "gracias por tu contacto"
            window.location.href = "/graciasportucontacto";
          } else {
            alert("Error al enviar los datos");
          }
        } catch (error) {
          alert("Ocurrió un error inesperado: " + error.message);
        } finally {
          // Ocultar el modal de "Enviando..."
          modal.classList.add("hidden");
        }
      }
    </script>

    <style>
      input[type="radio"]:checked + label {
        background-color: #3182ce;
        color: #fff;
      }
    </style>
  </Frame>
</Layout>
